## 1. æ­»é”

æ­»é”çš„äº§ç”Ÿï¼šç»†ç²’åº¦çš„å¤šæŠŠé”ğŸ”’ä¸‹ï¼Œè¦åŒæ—¶è·å–å¯¹æ–¹çš„é”èµ„æº

æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”

- t1çº¿ç¨‹è·å¾— Aå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Bå¯¹è±¡ çš„é”
- t2çº¿ç¨‹è·å¾— Bå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Aå¯¹è±¡ çš„é”

<hr>

ğŸ”—æ­»é”å‚ç”Ÿçš„æ¡ä»¶(ä¸‹åˆ—å››ä¸ªæ¡ä»¶å¿…é¡»åŒæ—¶æ»¡è¶³)ï¼š

1. äº’æ–¥
2. ä¸å¯æŠ¢å 
3. å æœ‰ä¸”ç­‰å¾…
4. å¾ªç¯ç­‰å¾…

**I. äº’æ–¥**

- å…±äº«èµ„æºåªèƒ½åŒæ—¶è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼Œé”ğŸ”’å…·æœ‰ç‹¬å æ€§

**II. ä¸å¯æŠ¢å **

- çº¿ç¨‹ä¸èƒ½å¼ºè¡ŒæŠ¢å å…¶ä»–çº¿ç¨‹çš„é”

**III. å æœ‰ä¸”ç­‰å¾…**

- å½“å‰çº¿ç¨‹æ‹¿åˆ°äº†ä¸€ä¸ªé”ï¼Œä¸é‡Šæ”¾çš„åŒæ—¶åˆå»ç”³è¯·å¦ä¸€ä¸ªé”

**IV. å¾ªç¯ç­‰å¾…**

- çº¿ç¨‹T1ç­‰å¾…çº¿ç¨‹T2å æœ‰çš„èµ„æºï¼Œçº¿ç¨‹T2åˆç­‰å¾…çº¿ç¨‹T1å æœ‰çš„èµ„æºï¼ŒåŒæ–¹æŠ±ç€å¯¹æ–¹éœ€è¦çš„èµ„æºå½¢æˆåƒµæŒ

ã€è§£å†³æ­»é”çš„æ€è·¯ã€‘ï¼šç ´åå‚ç”Ÿæ¡ä»¶çš„ä»»æ„ä¸€ä¸ª

**ã€æ­»é”åœºæ™¯æ¨¡æ‹Ÿã€‘**

ä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”

- t1çº¿ç¨‹è·å¾— Aå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Bå¯¹è±¡ çš„é”
- t2çº¿ç¨‹è·å¾— Bå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Aå¯¹è±¡ çš„é”

```java
public class DeadLock {
    public static void main(String[] args) {
        Object A = new Object();
        Object B = new Object();
        Thread t1 = new Thread(() -> {
            synchronized (A) {
                try {
                    System.out.println("çº¿ç¨‹[" + Thread.currentThread().getName()+"] å·²è·å–Aå¯¹è±¡çš„é”...");
                    Thread.sleep(1000);
                    synchronized (B) {
                        System.out.println("çº¿ç¨‹[" + Thread.currentThread().getName()+"] æƒ³è¦è·å–Bå¯¹è±¡çš„é”...");
                    }
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "t1");

        Thread t2 = new Thread(() -> {
            synchronized (B) {
                try {
                    System.out.println("çº¿ç¨‹[" + Thread.currentThread().getName()+"] å·²è·å–Bå¯¹è±¡çš„é”...");
                    Thread.sleep(2000);
                    synchronized (A) {
                        System.out.println("çº¿ç¨‹[" + Thread.currentThread().getName()+"] æƒ³è¦è·å–Bå¯¹è±¡çš„é”...");
                    }
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "t2");

        t1.start();
        t2.start();
    }
}

```

![image-20200823135135059](7.æ­»é”åŠLocké”ä½“ç³».assets/image-20200823135135059.png)

<br>

## 2. æ­»é”çš„å®šä½

### å‘½ä»¤è¡Œjstack

**1. `jps`æŸ¥çœ‹Javaè¿›ç¨‹id**

![image-20200823135640790](7.æ­»é”åŠLocké”ä½“ç³».assets/image-20200823135640790.png)

**2. jstackæŸ¥çœ‹å½“å‰çº¿ç¨‹ä¿¡æ¯**

![image-20200823135835637](7.æ­»é”åŠLocké”ä½“ç³».assets/image-20200823135835637.png)

ã€æ—¥å¿—æ˜¾ç¤ºã€‘

```java
2020-08-23 13:57:47
Full thread dump Java HotSpot(TM) Client VM (25.181-b13 mixed mode):

"DestroyJavaVM" #11 prio=5 os_prio=0 tid=0x02c4ec00 nid=0x5270 waiting on condition [0x00000000]
   java.lang.Thread.State: RUNNABLE

"t2" #10 prio=5 os_prio=0 tid=0x159c4400 nid=0x14c waiting for monitor entry [0x1607f000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at com.iqqcode.thread10.DeadLock.lambda$main$1(DeadLock.java:32)
        - waiting to lock <0x055a39c8> (a java.lang.Object)
        - locked <0x055a39d0> (a java.lang.Object)
        at com.iqqcode.thread10.DeadLock$$Lambda$2/17259968.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

"t1" #9 prio=5 os_prio=0 tid=0x159c3c00 nid=0x2314 waiting for monitor entry [0x15fef000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at com.iqqcode.thread10.DeadLock.lambda$main$0(DeadLock.java:18)
        - waiting to lock <0x055a39d0> (a java.lang.Object)
        - locked <0x055a39c8> (a java.lang.Object)
        at com.iqqcode.thread10.DeadLock$$Lambda$1/19993396.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)


Found one Java-level deadlock:
=============================
"t2":
  waiting to lock monitor 0x158798dc (object 0x055a39c8, a java.lang.Object),
  which is held by "t1"
"t1":
  waiting to lock monitor 0x1587b31c (object 0x055a39d0, a java.lang.Object),
  which is held by "t2"

Java stack information for the threads listed above:
===================================================
"t2":
        at com.iqqcode.thread10.DeadLock.lambda$main$1(DeadLock.java:32)
        - waiting to lock <0x055a39c8> (a java.lang.Object)
        - locked <0x055a39d0> (a java.lang.Object)
        at com.iqqcode.thread10.DeadLock$$Lambda$2/17259968.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
"t1":
        at com.iqqcode.thread10.DeadLock.lambda$main$0(DeadLock.java:18)
        - waiting to lock <0x055a39d0> (a java.lang.Object)
        - locked <0x055a39c8> (a java.lang.Object)
        at com.iqqcode.thread10.DeadLock$$Lambda$1/19993396.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.

```

![image-20200823140155772](7.æ­»é”åŠLocké”ä½“ç³».assets/image-20200823140155772.png)

![image-20200823140521579](7.æ­»é”åŠLocké”ä½“ç³».assets/image-20200823140521579.png)



### å¯è§†åŒ–jconsole

> JProfileå½“ç„¶æ›´å¼ºå¤§

**1. `jps`æŸ¥çœ‹Javaè¿›ç¨‹id**

**2. æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€**

![image-20200823141123981](7.æ­»é”åŠLocké”ä½“ç³».assets/image-20200823141123981.png)



## 3. è§£å†³æ­»é”é—®é¢˜

**ç ´åæ­»é”å æœ‰ä¸”ç­‰å¾…çš„æ¡ä»¶ï¼Œè®©ä¸¤ä¸ªçº¿ç¨‹ä¸å†åŒæ—¶æ‹¿åˆ°å¯¹æ–¹æƒ³è¦çš„é”**

Lockè§£å†³æ­»é”ï¼Œ**ç ´åä¸å¯æŠ¢å **ï¼š

1. å“åº”ä¸­æ–­`lockInterruptibly`
2. æ”¯æŒè¶…æ—¶`boolean tryLock(long time, TimeUnit unit)`
3. éé˜»å¡å¼è·å–é”ï¼Œçº¿ç¨‹è‹¥è·å–ä¸åˆ°é”ï¼Œçº¿ç¨‹ç›´æ¥é€€å‡º`boolean tryLock()`

åœ¨Lockæ¥å£å‡ºç°ä¹‹å‰ï¼ŒJavaç¨‹åºä¸»è¦æ˜¯é `synchronized`å…³é”®å­—å®ç°é”åŠŸèƒ½ã€‚è€ŒJDK5ä¹‹åï¼Œå¹¶å‘åŒ…ä¸­å¢åŠ äº†Lockæ¥å£ï¼Œå®ƒæä¾›äº†ä¸synchronizedä¸€æ ·çš„é”åŠŸèƒ½ã€‚è™½ç„¶å®ƒå¤±å»äº†åƒsynchronizeéšå¼åŠ é”è§£é”çš„ä¾¿æ·æ€§(Locké”ä¸ºæ˜¾å¼)ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†è·å–é”å’Œé‡Šæ”¾é”çš„å¯æ“ä½œæ€§ï¼Œå¯ä¸­æ–­çš„è·å–é”ä»¥åŠè¶…æ—¶è·å–é”ç­‰å¤šç§synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„åŒæ­¥ç‰¹æ€§ï¼ˆsynchronizedé”æ˜¯äº’æ–¥çš„ï¼‰

<br>

## 4.å“²å­¦å®¶å°±é¤é—®é¢˜

<img src="7.æ­»é”.assets/20200315203417226.png" alt="img" style="zoom:70%;" />

æœ‰äº”ä½å“²å­¦å®¶ï¼Œå›´ååœ¨åœ†æ¡Œæ—ã€‚ä»–ä»¬åªåšä¸¤ä»¶äº‹ï¼Œæ€è€ƒå’Œåƒé¥­ï¼Œæ€è€ƒä¸€ä¼šåƒå£é¥­ï¼Œåƒå®Œé¥­åæ¥ç€æ€è€ƒã€‚

- åƒé¥­æ—¶è¦ç”¨ä¸¤æ ¹ç­·å­åƒï¼Œæ¡Œä¸Šå…±æœ‰5æ ¹ç­·å­ï¼Œæ¯ä½å“²å­¦å®¶å·¦å³æ‰‹è¾¹å„æœ‰ä¸€æ ¹ç­·å­ã€‚
- å¦‚æœç­·å­è¢«èº«è¾¹çš„äººæ‹¿ç€ï¼Œè‡ªå·±å°±å¾—ç­‰å¾…

## 5. æ´»é”

ä¸æ­»é”ç›¸å¯¹åº”ï¼Œè°ä¹Ÿæ— æ³•åœæ­¢å½“å‰çº¿ç¨‹çš„æ‰§è¡Œã€‚

ã€è§£å†³ã€‘ï¼šéšæœºå¢åŠ çº¿ç¨‹ä¼‘çœ æ—¶é—´