## 1. ReentrantLockç®€ä»‹

ç›¸å¯¹äºSynchronizedï¼ŒReentrantLockç‰¹ç‚¹å¦‚ä¸‹ï¼š

- å¯ä¸­æ–­
- å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´
- å¯è®¾ç½®ä¸ºå…¬å¹³é”
- æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡å®ç°ç­‰å¾…å”¤é†’æœºåˆ¶
- æ”¯æŒå¯é‡å…¥

ã€åŸºæœ¬ä½¿ç”¨ã€‘

<img src="8.ReentrantLock.assets/image-20200823155613613.png" alt="image-20200823155613613" style="zoom:80%;" />



**ç‹¬å é”**ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰æ­¤é”

**å…±äº«é”**ï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹æ‹¥æœ‰é”ï¼ˆè¯»å†™é”æ˜¯å…±äº«é”çš„ä¸€ç§ï¼Œè¯»é”å…±äº«ï¼Œå†™é”ç‹¬å ï¼‰

**ReentrantLockå¯é‡å…¥é”ï¼š** Lockçš„å®ç°ç±»ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡å¯¹é”çš„è®¡æ•°å™¨`+1`

synchronizedæœ‰å¯é‡å…¥é”ï¼Œä½†æ˜¯é‡é‡çº§çš„é”

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](8.ReentrantLock.assets/20200528172808560.png)

## 2. å¯é‡å…¥é”

ä¸‰ä¸ªæ–¹æ³•å‡ä¸Šé”ğŸ”’ï¼ŒéªŒè¯å¯é‡å…¥æ€§ï¼š

- `main()`ä¸­åœ¨æœªè§£é”ä¹‹å‰è°ƒç”¨`method1()`
- `method1()`ä¸­åœ¨æœªè§£é”ä¹‹å‰è°ƒç”¨`method2()`

```java
public class ReentrantLockTest {

    static ReentrantLock lock = new ReentrantLock();

    public static void main(String[] args) {
        lock.lock();
        try {
            System.out.println("enter main");
            //åœ¨æœªè§£é”ä¹‹å‰è°ƒç”¨method1()
            method1();
        } finally {
            lock.unlock();
        }
    }

    public static void method1() {
        lock.lock();
        try {
            System.out.println("enter method1...");
            //é”é‡å…¥
            method2();
        } finally {
            lock.unlock();
        }
    }

    public static void method2() {
        lock.lock();
        try {
            //é”é‡å…¥
            System.out.println("enter method2...");
        } finally {
            lock.unlock();
        }
    }
}
```

> enter main
>
> enter method1...
>
> enter method2...

<br>

##  3. å…¬å¹³é”ä¸éå…¬å¹³é”

ã€æºç æŸ¥çœ‹ï¼šReentrantLockã€‘

![](8.ReentrantLock.assets/20200616095524.png)

é»˜è®¤æ— å‚æ„é€ åˆ›å»ºçš„æ˜¯éå…¬å¹³é”ï¼Œä¼ å…¥`true`ä»£è¡¨å®ç°å…¬å¹³é”ã€‚

**å…¬å¹³é”éå…¬å¹³é”æµ‹è¯•**

```java
class FairUnfair {
    private Lock lock;

    public FairUnfair(boolean isfair) {
        //é»˜è®¤æ— å‚ä¸ºéå…¬å¹³é”
        lock = new ReentrantLock(isfair);
    }

    public void foo() {
        try {
            lock.lock();
            System.out.println(Thread.currentThread().getName() + "è·å¾—é”");
        } finally {
            lock.unlock();
        }
    }
}

class ThreadService extends Thread {
    private FairUnfair service;

    public ThreadService(FairUnfair service) {
        this.service = service;
    }

    @Override
    public void run() {
        service.foo();
    }
}

public class FairUnfairLock {
    public static void main(String[] args) {
        //FairUnfair fu = new FairUnfair(false); //éå…¬å¹³é”
        FairUnfair fu = new FairUnfair(true); //å…¬å¹³é”
        Thread[] threads = new Thread[20];
        //åˆ›å»ºçº¿ç¨‹ç»„æµ‹è¯•
        for (int i = 0; i < threads.length; i++) {
            threads[i] = new ThreadService(fu);
        }
        //å°½é‡åŒæ—¶å¯åŠ¨çº¿ç¨‹ç»„
        for (int i = 0; i < threads.length; i++) {
            threads[i].start();
        }
    }
}


```

![](8.ReentrantLock.assets/20200616103010.png)

![](8.ReentrantLock.assets/20200616104027.png)

<br>



## 4. å¯ä¸­æ–­

**å¯ä¸­æ–­ï¼šè¢«åŠ¨çš„è¿‡ç¨‹ï¼Œè·å–ä¸åˆ°é”ä¼šå¤„äºé˜»å¡è½¬æ€ï¼›é˜»å¡åè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ï¼Œé˜²æ­¢æ— é™çš„ç­‰å¾…**

- å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œè·å–Lockå¯¹è±¡é”

- å¦‚æœæœ‰ç«äº‰ï¼Œå°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œä¸€ç›´ç­‰å¾…
- å¯ä»¥è¢«å…¶å®ƒçº¿ç¨‹ç”¨ `interrupt`æ–¹æ³•æ‰“æ–­é˜»å¡ç­‰å¾…çš„çŠ¶æ€



<br>

## 5. æ”¯æŒè¶…æ—¶tryLock

**é”å¯æ‰“æ–­æ˜¯è¢«åŠ¨çš„è¿‡ç¨‹ï¼Œè¶…æ—¶æ˜¯ä¸»åŠ¨çš„è¿‡ç¨‹**

- å¦‚æœè·å–é”å¤±è´¥ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åè‡ªåŠ¨æ”¾å¼ƒè·å–

```java
class ThreadLockTime implements Runnable {
    private Lock lock = new ReentrantLock(); //å®ç° Lockçš„æ¥å£
    @Override
    public void run() {
        fun();
    }

    private void fun() {
        try {
            if(lock.tryLock(1,TimeUnit.SECONDS)) {
                System.out.println(Thread.currentThread().getName() + "è·å–é”æˆåŠŸï¼");
                // sleep 2000ms,çº¿ç¨‹Bè·å–ä¸åˆ°é”
                Thread.sleep(2000);
            }else {
                System.err.println(Thread.currentThread().getName() + "è·å–é”å¤±è´¥...");
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}

public class LockTime {
    public static void main(String[] args) {
        ThreadLockTime threadLockTime = new ThreadLockTime();
        new Thread(threadLockTime,"ThreadA").start();
        new Thread(threadLockTime,"ThreadB").start();
    }
}
```

ä»£ç åˆ†æï¼š

`boolean tryLock(long timeout, TimeUnit unit)` 
å¦‚æœåœ¨ç»™å®šçš„ç­‰å¾…æ—¶é—´å†…æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹å ç”¨ ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹å°šæœªè¢«ä¿ç•™ï¼Œåˆ™è·å–è¯¥é”interrupted

A,Bçº¿ç¨‹è·å–é”æˆåŠŸæ˜¯éšæœºçš„ï¼Œçœ‹æ“ä½œç³»ç»Ÿçš„è°ƒåº¦. æˆ‘ä»¬ä»¥Açº¿ç¨‹è·å–é”æˆåŠŸä¸ºä¾‹

åœ¨run( )ä¸­è°ƒç”¨fun( ),ç»™å®šçš„ç­‰å¾…æ—¶é—´ä¸º  `if(lock.tryLock(1,TimeUnit.SECONDS))` 1s,çº¿ç¨‹Aå…ˆæ‹¿åˆ°é”ä¹‹åï¼Œçº¿ç¨‹Bæƒ³è¦è·å–é”æ—¶ï¼Œå¿…é¡»å¾—å…ˆsleep 2s;

ä¼‘çœ çš„æ—¶é—´å¤§äºç»™å®šçš„ç­‰å¾…æ—¶é—´ï¼Œæ‰€ä»¥çº¿ç¨‹Bè·å–é”å¤±è´¥äº†ï¼

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](8.ReentrantLock.assets/20190805163843262-1598168534294.png)

> PSï¼šä¸€ä¸ªå¾ˆç„å­¦çš„é—®é¢˜ï¼Œä¸Šé¢çš„æµ‹è¯•ç¨‹åºåœ¨Windowsä¸‹æµ‹è¯•ï¼Œæ„é€ æ–¹æ³•æ— è®ºæ˜¯ä¼ å…¥`true`æˆ–è€…`false`ï¼Œç»“æœéƒ½æ˜¯éå…¬å¹³çš„ï¼ä½†æ˜¯åœ¨Linuxæˆ–è€…mac OSä¸Šåˆ™ç›¸åï¼Œéƒ½æ˜¯å…¬å¹³çš„ã€‚
>
> æŸ¥èµ„æ–™æ²¡æ‰¾åˆ°å…·ä½“çš„è¯´æ˜ï¼Œæˆ‘çŒœæµ‹å¯èƒ½æ˜¯ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œè°ƒåº¦çº¿ç¨‹çš„æ–¹å¼ä¸åŒå§ï¼Œæ‰å¯¼è‡´å‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚

<br>



## 6. Conditionå®ç°ç²¾å‡†ç­‰å¾…å”¤é†’

`synchronized`å…³é”®å­—ï¼Œå®ƒé…åˆObject çš„`wait`ã€`notify`ç³»åˆ—æ–¹æ³•å¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚å¯¹äºLockï¼Œé€šè¿‡Conditionä¹Ÿå¯ä»¥å®ç°**ç­‰å¾…/é€šçŸ¥**æ¨¡å¼

Conditionæ˜¯åœ¨JDK 1.5ä¸­å‡ºç°çš„ï¼Œå®ƒç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„Objectçš„waitã€notifyå®ç°çº¿ç¨‹é—´çš„åä½œï¼Œç›¸æ¯”ä½¿ç”¨Objectçš„waitã€notifyï¼Œä½¿ç”¨Conditionçš„`await`ã€`signal`è¿™ç§æ–¹å¼å®ç°çº¿ç¨‹é—´åä½œæ›´åŠ å®‰å…¨å’Œé«˜æ•ˆã€‚å› æ­¤é€šå¸¸æ¥è¯´æ¯”è¾ƒæ¨èä½¿ç”¨Conditionï¼Œé˜»å¡é˜Ÿåˆ—å®é™…ä¸Šæ˜¯ä½¿ç”¨äº†Conditionæ¥æ¨¡æ‹Ÿçº¿ç¨‹é—´åä½œ

![](8.ReentrantLock.assets/20200606102702.png)

Lockå’ŒConditionçš„å…³ç³»ï¼š

Lockåªèƒ½å®ç°äº’æ–¥ï¼ˆä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œå¦å¤–çš„çº¿ç¨‹ä¸èƒ½è®¿é—®è¯¥é”ï¼‰ï¼Œä½†æ˜¯ä¸èƒ½å®ç°é€šä¿¡ã€‚è€ŒConditionå¯ä»¥å®ç°çº¿ç¨‹ä¹‹é—´çš„åˆä½œé€šä¿¡ï¼Œ**å³ä½¿å½“å‰çº¿ç¨‹è·å–äº†CPUçš„æ‰§è¡Œæƒï¼Œä½†æ˜¯Conditionä¹Ÿå¯ä»¥è®©å½“å‰çº¿ç¨‹å‡ºæ‰§è¡Œæƒï¼Œé€šçŸ¥å¦å¤–çš„çº¿ç¨‹æ‰§è¡Œ**ã€‚

Conditionæ˜¯ä¸ªæ¥å£ï¼ŒåŸºæœ¬çš„æ–¹æ³•å°±æ˜¯`await`å’Œ`signal`æ–¹æ³•

ä¸€ä¸ª`Condition`å®ä¾‹æœ¬è´¨ä¸Šç»‘å®šåˆ°ä¸€ä¸ªé”ã€‚ è¦è·å¾—ç‰¹å®š`Condition`å®ä¾‹çš„Conditionå®ä¾‹ï¼Œä½¿ç”¨å…¶`newCondition()`æ–¹æ³•

JDKå®˜æ–¹æ–‡æ¡£ä½¿ç”¨è¯´æ˜ï¼š

![](8.ReentrantLock.assets/20200606103435.png)

è°ƒç”¨Conditionçš„`await`å’Œ`signal`æ–¹æ³•ï¼Œéƒ½å¿…é¡»åœ¨Lockä¿æŠ¤ä¹‹å†…ï¼Œå°±æ˜¯è¯´å¿…é¡»åœ¨lock.lock()å’Œlock.unlockä¹‹é—´æ‰å¯ä»¥ä½¿ç”¨Conditonä¸­çš„awaiå’Œsignalï¼Œç”¨æ³•å’Œwaitã€notifyç±»ä¼¼

### Conditonçš„ä¼˜åŠ¿

åŒæ ·æ˜¯çº¿ç¨‹ç­‰å¾…å”¤é†’ï¼Œé‚£Conditionç›¸æ¯”äºObjectä¸­waitå’Œnotifyçš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ

`notify`åªèƒ½æ˜¯å”¤é†’å¤„äº`wait`çŠ¶æ€çš„çº¿ç¨‹ï¼Œè®©çº¿ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­å‡ºæ¥é‡æ–°è·å–é”ã€‚å¦‚æœæ­¤æ—¶æˆ‘æœ‰å¤šä¸ªçº¿ç¨‹å¤„äºWAINTINGçŠ¶æ€ï¼Œæˆ‘åˆä¸æƒ³å…¨éƒ¨å°†ä»–ä»¬å”¤é†’ï¼Œåªå”¤é†’å…¶ä¸­ç‰¹å®šçš„å‡ ä¸ªã€‚

æŸ¥å®Œwaitæ–¹æ³•ç›¸å…³çš„APIä¹‹åï¼Œå‘ç°å®ƒå¹²ä¸äº†è¿™ä¸ªäº‹ï¼Œè¦ä¹ˆå°±æ˜¯å…¨éƒ¨å”¤é†’äº†ã€‚

![](8.ReentrantLock.assets/20200606104520.png)

é‚£è¿™ä¸ªåœºæ™¯ï¼Œå°±éœ€è¦Conditionå‡ºé©¬äº†ã€‚

**Conditionçš„ä¼˜åŠ¿ï¼šèƒ½å¤Ÿç²¾å‡†çš„é€šçŸ¥å’Œå”¤é†’çº¿ç¨‹**

æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç²¾å‡†å”¤é†’çš„ä¾‹å­ã€‚

### çº¿ç¨‹çš„è½®æµå”¤é†’

ä¸‰ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ—¶ï¼Œå…¶ä»–ä¸¤ä¸ªçº¿ç¨‹å¤„äºç­‰å¾…ä¸­ã€‚

- Aæ‰§è¡Œå®Œåï¼Œå”¤é†’Bçº¿ç¨‹

- Bæ‰§è¡Œå®Œåï¼Œå”¤é†’Cçº¿ç¨‹

- Cæ‰§è¡Œå®Œåï¼Œå”¤é†’Açº¿ç¨‹

```java
/**
 * @Author: Mr.Q
 * @Date: 2020-06-03 18:41
 * @Description:ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹
 * @Solution: çº¿ç¨‹A -> çº¿ç¨‹B -> çº¿ç¨‹C (äº¤æ›¿æ‰§è¡Œ,ä¾æ¬¡å”¤é†’ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªåœ¨æ‰§è¡Œ)
 */

class Data {

    private int number = 1;

    Lock lock = new ReentrantLock();
    Condition condition1 = lock.newCondition();
    Condition condition2 = lock.newCondition();
    Condition condition3 = lock.newCondition();


    //condition.await() ç­‰å¾…
    //condition.signal() å”¤é†’

    //æ‰§è¡ŒAä¸šåŠ¡
    public void workA()  {
        lock.lock();
        try {
            //ä¸šåŠ¡ï¼šåˆ¤æ–­ -> æ‰§è¡Œ -> é€šçŸ¥
            while (number != 1) {
               condition1.await(); //ç­‰å¾…
            }
            System.out.println(Thread.currentThread().getName() + " -> " + number);
            number = 2;
            //çº¿ç¨‹Aæ‰§è¡Œå®Œï¼Œå”¤é†’çº¿ç¨‹B
            condition2.signal();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    //æ‰§è¡ŒBä¸šåŠ¡
    public void workB() {
        lock.lock();
        try {
            while (number != 2) {
                condition2.await();
            }
            System.out.println(Thread.currentThread().getName() + " --> " + number);
            number = 3;
            //çº¿ç¨‹Bæ‰§è¡Œå®Œï¼Œå”¤é†’çº¿ç¨‹C
            condition3.signal();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    //æ‰§è¡ŒCä¸šåŠ¡
    public void workC() {
        lock.lock();
        try {
            while (number != 3) {
                condition3.await();
            }
            System.out.println(Thread.currentThread().getName() + " --> " + number);
            number = 1;
            //çº¿ç¨‹Bæ‰§è¡Œå®Œï¼Œå”¤é†’çº¿ç¨‹C
            condition1.signal();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}

public class Condition_wait_notify {
    public static void main(String[] args) {
        Data data = new Data();

        new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                data.workA();
            }
        },"çº¿ç¨‹A").start();

        new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                data.workB();
            }
        },"çº¿ç¨‹B").start();

        new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                data.workC();
            }
        },"çº¿ç¨‹C").start();
    }
}
```

ä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼š

![](8.ReentrantLock.assets/20200606105348.png)

<br>

-----------------------------

ã€å‚è€ƒé“¾æ¥ã€‘ï¼š[Javaå¤šçº¿ç¨‹ä¹‹Conditionçš„ä½¿ç”¨](https://blog.csdn.net/yucaixiang/article/details/89357690?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522159140913219195239837882%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=159140913219195239837882&biz_id=0)
