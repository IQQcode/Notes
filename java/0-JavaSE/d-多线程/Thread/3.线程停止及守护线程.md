## çº¿ç¨‹çš„åœæ­¢

**ä¸‰ç§æ–¹å¼åœæ­¢å½“å‰çº¿ç¨‹**

1. è®¾ç½®æ ‡è®°ä½ï¼Œçº¿ç¨‹æ­£å¸¸é€€å‡º
2. ä½¿ç”¨stopæ–¹æ³•å¼ºåˆ¶çº¿ç¨‹é€€å‡ºï¼Œè¯¥æ–¹æ³•ä¸å®‰å…¨å·²è¢«å¼ƒç”¨
3. ä½¿ç”¨interruptæ–¹æ³•ä¸­æ–­çº¿ç¨‹

### 1. è®¾ç½®æ ‡å¿—ä½

**è®¾ç½®æ ‡å¿—ä½(æ— æ³•å¤„ç†çº¿ç¨‹é˜»å¡æ—¶çš„é—®é¢˜)**

```java
class TStop implements Runnable {
    //è®¾ç½®æ ‡å¿—ä½
    private boolean flag = true;

    @Override
    public void run() {
        int i = 0;
        while (flag) {
            System.out.println(Thread.currentThread().getName() + "æ‰§è¡Œ i = " + (i++));
        }
    }

    //è½¬æ¢æ ‡å¿—ä½
    public void setFlag() {
        this.flag = false;
    }
}

public class ThreadStop {
    public static void main(String[] args) throws InterruptedException {
        TStop tp = new TStop();
        Thread thread = new Thread(tp,"çº¿ç¨‹A");
        thread.start();
        for (int i = 0; i < 1000; i++) {
            System.out.println("[main]->" + i);
            if (i == 900) {
                //thread.stop();ä¸å»ºè®®ä½¿ç”¨stopæ–¹æ³•å¼ºåˆ¶åœæ­¢çº¿ç¨‹
                tp.setFlag();
                Thread.sleep(100);
                System.err.println("çº¿ç¨‹Aæ‰§ç»“æŸï¼");
            }
        }
    }
}
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200527192534141.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzIzMjk1NQ==,size_16,color_FFFFFF,t_70)

### 2. stopæ–¹æ³•å¼ºè¡Œå…³é—­çº¿ç¨‹

ä¸ºä»€ä¹ˆè¯´stopæ–¹æ³•å¼ºè¡Œå…³é—­çº¿ç¨‹ä¸å®‰å…¨å‘¢ï¼Ÿ

å› ä¸ºstopä¼šè§£é™¤ç”±çº¿ç¨‹è·å–çš„æ‰€æœ‰é”ï¼Œå½“åœ¨ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ä¸Šè°ƒç”¨stop()æ–¹æ³•æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹å¯¹è±¡æ‰€è¿è¡Œçš„çº¿ç¨‹å°±ä¼š**ç«‹å³åœæ­¢**ã€‚

å‡å¦‚ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼š

    synchronized void { x = 3; y = 4;} 

ç”±äºæ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œå¤šä¸ªçº¿ç¨‹è®¿é—®æ—¶æ€»èƒ½ä¿è¯xï¼Œyè¢«åŒæ—¶èµ‹å€¼ï¼Œè€Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œåˆ° `x=3` æ—¶ï¼Œè¢«è°ƒç”¨äº†stopæ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«å¼ºåˆ¶åœæ­¢æ‰§è¡Œï¼Œå¯¼è‡´`y`æ²¡æœ‰è¢«èµ‹å€¼ã€‚å³ä½¿åœ¨åŒæ­¥å—ä¸­ï¼Œå®ƒä¹Ÿä¼šç«‹å³stopï¼Œè¿™æ ·å°±äº§ç”Ÿäº†ä¸å®Œæ•´çš„æ®‹ç¼ºæ•°æ®ã€‚

---------------------

### 3.è°ƒç”¨Threadç±»æä¾›çš„interrupt

è‹¥çº¿ç¨‹ä¸­æ²¡æœ‰ä½¿ç”¨ç±»ä¼¼`sleep/wait/join`æ—¶(ä½¿çº¿ç¨‹è¿›å…¥é˜»å¡æ€)ï¼Œè°ƒç”¨æ­¤çº¿ç¨‹å¯¹è±¡çš„`interrupt` **ä¸ä¼šçœŸæ­£ä¸­æ–­çº¿ç¨‹**ï¼Œåªæ˜¯ç®€å•çš„å°†çº¿ç¨‹çš„çŠ¶æ€ç½®ä¸ºinterruptè€Œå·²ï¼Œæ ¹æ®æ­¤çŠ¶æ€æ¥è¿›ä¸€æ­¥ç¡®å®šå¦‚ä½•å¤„ç†çº¿ç¨‹

```java
public class ThreadInterrupt implements Runnable {
    @Override
    public void run() {
        while (true) {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                System.err.println("æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼");
                e.printStackTrace();
                break;
            }
        }
    }

    public static void main(String[] args) throws InterruptedException {
        ThreadInterrupt tr = new ThreadInterrupt();
        Thread thread = new Thread(tr);
        Thread.sleep(1000);
        thread.start();
        System.out.println("æ˜¯å¦ä¸­æ–­ï¼Ÿ"+ thread.isInterrupted());
        thread.interrupt();
        System.out.println("æ˜¯å¦ä¸­æ–­ï¼Ÿ"+ thread.isInterrupted());
    }
}
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200527201703406.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzIzMjk1NQ==,size_16,color_FFFFFF,t_70)  

Threadç±»æä¾›çš„`isInterrupted`æ–¹æ³•ï¼Œæµ‹è¯•è¿™ä¸ªçº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­

- å¦‚æœä¸º`true`ï¼Œåˆ™åœæ­¢å½“å‰çº¿ç¨‹çš„æ‰§è¡Œ
- å¦‚æœä¸º`false`ï¼Œåˆ™ç»§ç»­æ‰§è¡Œ

è‹¥çº¿ç¨‹ä¸­è°ƒç”¨äº†é˜»å¡çº¿ç¨‹çš„æ–¹æ³•`sleep/wait/join`æ–¹æ³•ï¼Œè¯¥çº¿ç¨‹åœ¨é˜»å¡æ—¶è¢«æ‰“æ–­ã€‚æ­¤æ—¶å†æ‰ç”¨çº¿ç¨‹çš„ `interrupt`æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ŒåŒæ—¶çº¿ç¨‹çŠ¶æ€è¿˜åŸ isInterrupted = falseï¼Œåˆæ¢å¤æ‰§è¡Œ

ã€æµ‹è¯•æ¡ˆä¾‹ã€‘

- ç›‘æ§çº¿ç¨‹æ¯éš”1sè¾“å‡ºä¸€æ¬¡ç›‘æ§æ—¥å¿—
- ç›‘æ§5såï¼Œè®©ç›‘æ§çº¿ç¨‹åœæ­¢æ‰§è¡Œ

> è¦é‡ç½®ä¸­æ–­æ ‡å¿—ä½ï¼Œå¦åˆ™å¼‚å¸¸åç»§ç»­æ‰§è¡Œ

```java
class TwoPhaseTermination {

    private Thread monitor;

    //å¯åŠ¨ç›‘æ§çº¿ç¨‹ï¼Œæµ‹è¯•å…¶è¢«æ‰“æ–­çš„çŠ¶æ€,ä¸æ‰“æ–­æ¯éš”ä¸€ç§’æ‰§è¡Œä¸€æ¬¡ç›‘æ§
    public void start() {
        monitor = new Thread(() -> {
            while(true) {
                Thread current = Thread.currentThread();
                //å¦‚æœè¢«æ‰“æ–­äº†ï¼Œåˆ™çº¿ç¨‹åœæ­¢æ‰§è¡Œ
                if(current.isInterrupted()) {
                    System.out.println("çº¿ç¨‹åœæ­¢æ‰§è¡Œ");
                    break;
                }
                
                try {
                    Thread.sleep(1000);
                    System.out.println("æ‰§è¡Œç›‘æ§è®°å½•ï¼");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                    //é‡æ–°è®¾ç½®ä¸­æ–­æ ‡è®°ä½ã€‚å› ä¸ºä¸­æ–­ååˆä¼šæ¢å¤ä¸ºisInterrupted = false
                    // è¿˜ä¼šç»§ç»­æ‰§è¡Œ
                    current.interrupt();
                }
            }
        });
        monitor.start();
    }

    //åœæ­¢ç›‘æ§çº¿ç¨‹
    public void stop() {
        monitor.interrupt();
    }
}

public class ThreadInterrupt {
    public static void main(String[] args) throws InterruptedException {
        TwoPhaseTermination tpt = new TwoPhaseTermination();
        tpt.start(); //å¯åŠ¨ç›‘æ§
        Thread.sleep(5000);
        tpt.stop(); //5såœæ­¢ç›‘æ§
    }
}
```

é‡ç½®æ ‡è®°ä½`current.interrupt();`

![image-20200820125922491](3.çº¿ç¨‹åœæ­¢åŠå®ˆæŠ¤çº¿ç¨‹.assets/image-20200820125922491.png)

**æ²¡æœ‰é‡ç½®ä¸­æ–­æ ‡å¿—ä½ï¼Œç»§ç»­æ‰§è¡Œ**ã€‚

å› ä¸ºä¸­æ–­ååˆä¼šæ¢å¤ä¸ºåˆå§‹æ²¡è¢«æ‰“æ–­çš„çŠ¶æ€`isInterrupted = false`ï¼Œè¿˜ä¼šç»§ç»­æ‰§è¡Œ

![image-20200820130353327](3.çº¿ç¨‹åœæ­¢åŠå®ˆæŠ¤çº¿ç¨‹.assets/image-20200820130353327.png)

**interrupt()æºç ï¼š**

`interrupt0()`ä¸ºä¸­æ–­æ ‡å¿—ä½
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20190726165848221.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzIzMjk1NQ==,size_16,color_FFFFFF,t_70)

## çº¿ç¨‹çš„ä¼˜å…ˆçº§

çº¿ç¨‹çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯ä¼˜å…ˆçº§è¶Šé«˜ **è¶Šæœ‰å¯èƒ½**è¢«å…ˆæ‰§è¡Œ

å°±æ‹¿ä¹°å½©ç¥¨æ¥è¯´ï¼Œä¹°100å¼ å½©ç¥¨çš„ä¸­å¥–å‡ ç‡ä¸€å®šæ˜¯å¤§äºä¸€å¼ çš„ï¼Œä½†æ˜¯ä¹°100å¼ å½©ç¥¨å°±ä¸€å®šä¼šä¸­å¥–å—ï¼Ÿæä¸€æï¼Œå•è½¦å˜æ‘©æ‰˜ğŸ¤£ï¼Ÿ

åŒæ ·çš„é“ç†ï¼Œçº¿ç¨‹çš„ä¼˜å…ˆçº§è¶Šé«˜ï¼Œ**è¶Šæœ‰å¯èƒ½**è¢«å…ˆæ‰§è¡Œã€‚æ‰§è¡Œçš„æœºç‡åŠ å¤§ï¼Œä½†å…·ä½“æ˜¯å¦æ‰§è¡Œï¼Œè¿˜å¾—çœ‹CPUçš„è°ƒåº¦

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200528091851424.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzIzMjk1NQ==,size_16,color_FFFFFF,t_70)

- **è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§**  `setPriority(int priority)`

- **è·å–ä¼˜å…ˆçº§**  `int getPriority`

JDKå†…ç½®çš„ä¸‰ç§ä¼˜å…ˆçº§ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200528092349243.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzIzMjk1NQ==,size_16,color_FFFFFF,t_70)

**<font color=#8B008B size=3>MAX_PRIORITYT = 10</font>**

**<font color=#8B008B size=3>NORM_PRIORITYT = 5</font>**

**<font color=#8B008B size=3>MIN_PRIORITYT = 1</font>**

> **main**çº¿ç¨‹é»˜è®¤çš„ä¼˜å…ˆçº§ä¸º NORM_PRIORITYT = 5

**ä¼˜å…ˆçº§çš„è®¾å®šï¼š** ä¼˜å…ˆçº§çš„è®¾å®šè¦æ”¾åˆ°å¯åŠ¨çº¿ç¨‹ä¹‹å‰

**çº¿ç¨‹çš„ç»§æ‰¿æ€§ï¼š** åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åˆ›å»ºäº†å­çº¿ç¨‹ï¼Œé»˜è®¤å­çº¿ç¨‹ä¸çˆ¶çº¿ç¨‹çš„ä¼˜å…ˆçº§ç›¸åŒ

ç†è®ºä¸Šä¼˜å…ˆçº§é«˜çš„å…ˆæ‰§è¡Œï¼Œä½†æ˜¯è¿˜å–å†³äºCPUçš„è°ƒåº¦
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200528094259369.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzIzMjk1NQ==,size_16,color_FFFFFF,t_70)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200528094102820.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzIzMjk1NQ==,size_16,color_FFFFFF,t_70)

---------------

## å®ˆæŠ¤çº¿ç¨‹

Javaä¸­çº¿ç¨‹åˆ†ä¸ºï¼š

- ç”¨æˆ·çº¿ç¨‹
- å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemonï¼‰

**å®ˆæŠ¤çº¿ç¨‹ä¸ºé™ªä¼´çº¿ç¨‹**ï¼Œåªè¦JVMä¸­å­˜åœ¨ä»»ä½•ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹æ²¡æœ‰ç»ˆæ­¢ï¼Œå®ˆæŠ¤çº¿ç¨‹å°±ä¸€ç›´åœ¨å·¥ä½œã€‚JVMå¿…é¡»ç¡®ä¿ç”¨æˆ·çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯ä¸ç”¨ç­‰å¾…å®ˆæŠ¤çº¿ç¨‹

é»˜è®¤åˆ›å»ºçš„çº¿ç¨‹éƒ½æ˜¯ç”¨æˆ·çº¿ç¨‹ï¼ŒåŒ…æ‹¬ä¸»çº¿ç¨‹

é€šè¿‡`setDaemon(true)`å°†çº¿ç¨‹å¯¹è±¡è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹

**å…¸å‹çš„å®ˆæŠ¤çº¿ç¨‹ï¼š**

- **åƒåœ¾å›æ”¶çº¿ç¨‹ã€å†…å­˜ç›‘æ§ã€æ—¥å¿—è®°å½•**
- **Tomcatä¸­çš„Accepter(æ¥æ”¶è¯·æ±‚)å’ŒPoller(åˆ†å‘è¯·æ±‚)çº¿ç¨‹ï¼Œåœ¨æ‰§è¡Œshutdownä¼šç«‹å³å…³é—­ï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚**

```java
class God implements Runnable {
    @Override
    public void run() {
        while (true) {
            System.out.println("God Bless you!");
        }
    }
}

class Person implements Runnable {
    @Override
    public void run() {
        for (int i = 0; i < 5; i++) {
            System.out.println("Live happily...");
        }
        System.err.println("--> æ’’ç”±é‚£æ‹‰ï¼ï¼ï¼");
    }
}

public class ThreadDaemon {
    public static void main(String[] args) throws InterruptedException {
        God god = new God();
        Person per = new Person();
        Thread thread = new Thread(god);
        //è®¾ç½®ä¸Šå¸ä¸ºå®ˆæŠ¤çº¿ç¨‹
        thread.setDaemon(true);
        thread.start();
        //å¯åŠ¨ç”¨æˆ·çº¿ç¨‹ 
        new Thread(per).start();
    }
}
```

å½“ç”¨æˆ·çº¿ç¨‹Personç»“æŸåï¼Œå®ˆæŠ¤çº¿ç¨‹å¹¶æ²¡æœ‰ç«‹å³åœæ­¢
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200528101126864.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzIzMjk1NQ==,size_16,color_FFFFFF,t_70)

å½“å‰ç¨‹åºåœæ­¢ï¼Œåˆ™å®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šè¢«å¼ºåˆ¶åœæ­¢ã€‚