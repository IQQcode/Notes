> æœ¬æ–‡è®²è¿°å•ä¾‹è®¾è®¡æ¨¡å¼çš„8ç§æ–¹å¼ï¼Œåå°„å’Œå•ä¾‹çš„ç›¸çˆ±ç›¸æ€ğŸ™ƒ

## å•ä¾‹æ¨¡å¼

**å•ä¾‹æ¨¡å¼ï¼šç±»çš„å¯¹è±¡æœ‰ä¸”åªæœ‰ä¸€ä¸ª**

é¦–å…ˆæ§åˆ¶å¯¹è±¡çš„äº§ç”Ÿæ•°é‡ï¼šå°†æ„é€ æ–¹æ³•ç§æœ‰åŒ–(ä»æºå¤´æ§åˆ¶å¯¹è±¡æ•°é‡,æ§åˆ¶æ„é€ æ–¹æ³•)

**æ„é€ æ–¹æ³•ç§æœ‰åŒ–ï¼š**

- ä»»ä½•å…¶ä»–ç±»å‡æ— æ³•å‚ç”Ÿæ­¤å¯¹è±¡(æœ¬è´¨æ˜¯ä»»ä½•ä»–ç±»å‡æ— æ³•è°ƒç”¨æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥æ— æ³•äº§ç”Ÿå¯¹è±¡)

- å”¯ä¸€çš„ä¸€ä¸ªå¯¹è±¡äº§ç”Ÿäºç±»å†…éƒ¨

- å”¯ä¸€çš„å±æ€§ä¸º<é™æ€å±æ€§>ï¼Œå¹¶ä¸”ç±»ä¸­æä¾›é™æ€æ–¹æ³•å–å¾—æ­¤å¯¹è±¡ã€‚å› ä¸ºç±»çš„å¤–éƒ¨æ— æ³•äº§ç”Ÿå¯¹è±¡ï¼Œå› æ­¤æ— æ³•è°ƒç”¨å¯¹è±¡æ–¹æ³•

## 1. é¥¿æ±‰å¼â€“é™æ€å¸¸é‡

é¥¿æ±‰å¼å•ä¾‹ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆé¥¥æ¸´ğŸ™ƒï¼Œä¸€ä¸Šæ¥å°±`new`äº§ç”Ÿå®ä¾‹åŒ–å¯¹è±¡

```java
/**
 * é¥¿æ±‰å¼ä¸‰ä¸ªæ ¸å¿ƒç»„æˆ
 *   1.æ„é€ æ–¹æ³•ç§æœ‰åŒ–
 *   2.ç±»å†…éƒ¨æä¾›é™æ€ç§æœ‰åŸŸ
 *   3.ç±»å†…éƒ¨æä¾›é™æ€æ–¹æ³•è¿”å›å”¯ä¸€å¯¹è±¡
 */

class Singletons {
    //å”¯ä¸€çš„å¯¹è±¡åœ¨ç±»åŠ è½½æ—¶äº§ç”Ÿ
    private final static Singletons single = new Singletons();

    //æ„é€ æ–¹æ³•ç§æœ‰åŒ–

    private Singletons() { }

    //é™æ€æ–¹æ³•-----ä¸ºä»€ä¹ˆæ˜¯é™æ€æ–¹æ³•ï¼Ÿï¼Ÿ
    //å› ä¸ºåœ¨ç±»çš„å¤–éƒ¨æ— æ³•äº§ç”Ÿå¯¹è±¡ï¼Œå› æ­¤æ— æ³•è°ƒç”¨å¯¹è±¡æ–¹æ³•
    //é€šè¿‡getteræ–¹æ³•å–å¾—å”¯ä¸€çš„å¯¹è±¡
    public static Singletons getInstance(){
        return single;
    }

    public void print() {
        System.out.println("é¥¿æ±‰å¼å•ä¾‹,ä¸Šæ¥ç›´æ¥newâ€¦â€¦");
    }
}

public class HungrySingleton01 {
    public static void main(String[] args) {
        //ä¸èƒ½ç›´æ¥new,è€Œæ˜¯é€šè¿‡ Singleton.getInstance()é™æ€æ–¹æ³•å–å¾—ç±»ä¸­å·²ç»äº§ç”Ÿå¥½çš„å¯¹è±¡
        Singletons single = Singletons.getInstance();
        Singletons single1 = Singletons.getInstance();
        System.out.println(single == single1);
        single.print();
    }
}
```

> å› ä¸ºæ˜¯é™æ€å¸¸é‡ï¼Œsingleå’Œsingle1ä¸€å®šæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€åœ¨çš„å†…å­˜åœ°å€æ˜¯ç›¸åŒçš„

**é¥¿æ±‰å¼å•ä¾‹ (é™æ€å¸¸é‡)**

**ã€ä¼˜ç‚¹ã€‘**ï¼šä¹¦å†™ç®€å•ï¼Œç±»åŠ è½½æ—¶å°±å®Œæˆäº†å®ä¾‹åŒ–ï¼Œé¿å…äº†çº¿ç¨‹åŒæ­¥é—®é¢˜

**ã€ç¼ºç‚¹ã€‘**ï¼šåœ¨ç±»åŠ è½½å°±å®Œæˆå®åŠ›åŒ–ï¼Œæ²¡æœ‰è¾¾åˆ°æ‡’åŠ è½½çš„æ•ˆæœã€‚å¦‚æœä»å§‹è‡³ç»ˆæ²¡æœ‰ä½¿ç”¨è¿‡è¿™ä¸ªå®ä¾‹å¯¹è±¡ï¼Œä¼šé€ æˆå†…å­˜æµªè´¹

**ã€æ€»ç»“ã€‘**

- å¯ç”¨ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆå†…å­˜èµ„æºçš„æµªè´¹

------------------

## 2. é¥¿æ±‰å¼â€“é™æ€ä»£ç å—

```java
class Singleton02 {
    private static Singleton02 single;

    private Singleton02() { }

    static {
        single = new Singleton02();
    }

    public static Singleton02 getInstance(){
        return single;
    }

    public void print() {
        System.out.println("é¥¿æ±‰å¼å•ä¾‹,é™æ€ä»£ç å—æ–¹å¼");
    }
}

public class HungrySingleton02 {
    public static void main(String[] args) {
        Singleton02 single = Singleton02.getInstance();
        Singleton02 single1 = Singleton02.getInstance();
        System.out.println(single == single1);
        single.print();
    }
}
```

**é¥¿æ±‰å¼å•ä¾‹ (é™æ€ä»£ç å—)**

è¿™ç§æ–¹å¼çš„ä¼˜ç¼ºç‚¹å’Œä¸Šé¢ç¬¬ä¸€ç§é™æ€å˜é‡çš„æ²¡å·®åˆ«ï¼ŒåŒºåˆ«å°±æ˜¯åˆå§‹åŒ–çš„ä½ç½®ä¸åŒï¼Œåˆå§‹åŒ–çš„è¿‡ç¨‹æ”¾åˆ°äº†é™æ€ä»£ç å—ã€‚

## 3. æ‡’æ±‰å¼â€“çº¿ç¨‹ä¸å®‰å…¨

å½“ç¬¬ä¸€æ¬¡å»ä½¿ç”¨Singletonå¯¹è±¡çš„æ—¶å€™æ‰ä¼šä¸ºå…¶äº§ç”Ÿå®ä¾‹åŒ–å¯¹è±¡

é€šè¿‡ä¸€ä¸ªé™æ€å…¬æœ‰æ–¹æ³•ï¼Œå½“ä½¿ç”¨åˆ°è¯¥æ–¹æ³•æ—¶ï¼Œæ‰åˆ›å»ºå¯¹è±¡(æ‡’æ±‰å¼)

```java
/**
 * @Author: Mr.Q
 * @Description:æ‡’æ±‰å¼å•ä¾‹---çº¿ç¨‹ä¸å®‰å…¨
 * ç‰¹ç‚¹: å½“ç¬¬ä¸€æ¬¡å»ä½¿ç”¨Singletonå¯¹è±¡çš„æ—¶å€™æ‰ä¼šä¸ºå…¶äº§ç”Ÿå®ä¾‹åŒ–å¯¹è±¡çš„æ“ä½œ.
 */
class Singleton {

    private static Singleton single;

    //private å£°æ˜æ— å‚æ„é€ 
    private Singleton() { }

    //é™æ€å…¬æœ‰æ–¹æ³•ï¼Œå½“ä½¿ç”¨åˆ°è¯¥æ–¹æ³•æ—¶ï¼Œæ‰åˆ›å»ºå¯¹è±¡(æ‡’æ±‰å¼)
    public static Singleton getInstance(){
        if(single == null) {
            single = new Singleton();
        }
        return single;
    }

    public void print() {
        System.out.println("æ‡’æ±‰å¼å•ä¾‹(çº¿ç¨‹ä¸å®‰å…¨)ï¼Œç”¨çš„æ—¶å€™å†newäº§ç”Ÿå¯¹è±¡â€¦â€¦");
    }
}

public class LazySingleton {
    public static void main(String[] args) {
        Singleton single = Singleton.getInstance();
        Singleton single1 = Singleton.getInstance();
        System.out.println(single == single1);
        single.print();
    }
}
```

**æ‡’æ±‰å¼å•ä¾‹ (çº¿ç¨‹ä¸å®‰å…¨)**

**ã€ä¼˜ç¼ºç‚¹ã€‘**

è¿™ç§å†™æ³•æ˜¯å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ã€‚ç±»æ¯”äºä¸Šé¢ä¸¤ç§é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼ï¼Œå®ƒä»¬åœ¨æ²¡æœ‰è°ƒç”¨æ—¶è™½ç„¶ä¼šé€ æˆå†…å­˜èµ„æºçš„æµªè´¹ï¼Œä½†æ˜¯æ˜¯å®‰å…¨çš„ã€‚å› ä¸ºåœ¨ç±»åŠ è½½æ—¶å°±å®Œæˆäº†å®ä¾‹åŒ–ï¼Œé¿å…äº†çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚

ä½†æ˜¯è¿™ç§æ‡’æ±‰å¼å†™æ³•ï¼Œèµ·åˆ°äº†æ‡’åŠ è½½æ•ˆæœï¼Œä½†æ˜¯åªèƒ½åœ¨å•çº¿ç¨‹ä¸‹ä½¿ç”¨

**ã€çº¿ç¨‹å®‰å…¨é—®é¢˜åˆ†æã€‘**

åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹è¿›å…¥äº†`getInstance`æ–¹æ³•çš„ifæ¡ä»¶åˆ¤æ–­`if(single == null)`ï¼Œè¿˜æ²¡æ¥å¾—åŠç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå¦ä¸€ä¸ªæ–°è¿›å…¥çš„çº¿ç¨‹ä¹Ÿé€šè¿‡äº†è¿™ä¸ªåˆ¤æ–­è¯­å¥ï¼Œè¿™æ˜¯å°±ä¼šäº§ç”Ÿå¤šä¸ªå®ä¾‹ï¼Œå°±ä¸æ˜¯å•ä¾‹çš„äº†ã€‚

æ‰€ä»¥æ­¤æ–¹æ³•åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ä¸å¯ä½¿ç”¨ã€‚

## 4. æ‡’æ±‰å¼â€“åŒæ­¥æ–¹æ³•

æ—¢ç„¶çº¿ç¨‹ä¸å®‰å…¨ï¼Œé‚£æˆ‘ä»¬ç»™ä»–åŠ æŠŠé”åœ¨`getInstance`æ–¹æ³•ä¸Šä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

```java
/**
 * @Author: Mr.Q
 * @Description:æ‡’æ±‰å¼å•ä¾‹---åŒæ­¥æ–¹æ³•(æ•ˆç‡å¤ªä½)
 */
class Singleton04 {

    private static Singleton04 single;

    //private å£°æ˜æ— å‚æ„é€ 
    private Singleton04() { }

    //é™æ€å…¬æœ‰æ–¹æ³•ï¼Œå½“ä½¿ç”¨åˆ°è¯¥æ–¹æ³•æ—¶ï¼Œæ‰åˆ›å»ºå¯¹è±¡(æ‡’æ±‰å¼)
    public synchronized static Singleton04 getInstance(){
        if(single == null) {
            single = new Singleton04();
        }
        return single;
    }

    public void print() {
        System.out.println("æ‡’æ±‰å¼å•ä¾‹(çº¿ç¨‹å®‰å…¨)ï¼ŒåŒæ­¥æ–¹æ³•æ•ˆç‡å¤ªä½");
    }
}

public class LazySingleton04 {
    public static void main(String[] args) {
        Singleton04 single = Singleton04.getInstance();
        single.print();
    }
}
```

**æ‡’æ±‰å¼å•ä¾‹(åŒæ­¥æ–¹æ³•)**

**ã€ä¼˜ç‚¹ã€‘**ï¼šè§£å†³äº†çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜

**ã€ç¼ºç‚¹ã€‘**

- æ•ˆç‡å¤ªä½ã€‚æ¯ä¸ªçº¿ç¨‹æƒ³è¦è·å–ç±»çš„å®ä¾‹æ—¶ï¼Œéƒ½è¦ç­‰åœ¨`getInstance`è¿™ä¸ªåŒæ­¥æ–¹æ³•å¤–ï¼Œä¸²å‹æ‰§è¡Œã€‚ä½†æ˜¯ç”±äºæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåªä¼šäº§ç”Ÿä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹å®ä¾‹åŒ–å®Œå¯¹è±¡ä¹‹åï¼Œåé¢çš„çº¿ç¨‹ä¾¿ä¸éœ€è¦æ‰§è¡Œifçš„æ¡ä»¶åˆ¤æ–­äº†ï¼Œç›´æ¥`return`å³å¯ï¼Œä½†æ˜¯åœ¨è¿›å…¥åŒæ­¥æ–¹æ³•æ—¶æ¯æ¬¡éƒ½è¦ç­‰å¾…ï¼Œæ•ˆç‡å¤ªä½ã€‚

## 5. æ‡’æ±‰å¼â€“åŒæ­¥ä»£ç å—

å…ˆæ¥è¯´ä¸€ç§<font color=red>é”™è¯¯ç¤ºèŒƒ</font>ï¼š

åœ¨`if`æ¡ä»¶ä¸­æ·»åŠ åŒæ­¥ä»£ç å—

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200609175944.png)

è¿™æ®µä»£ç çœ‹èµ·æ¥å¾ˆå®Œç¾ï¼Œå¾ˆå¯æƒœï¼Œå®ƒæ˜¯æœ‰é—®é¢˜ã€‚ä¸»è¦åœ¨äº`single= new Singleton()`è¿™å¥ï¼Œè¿™å¹¶éæ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚

æ­¤å¤„ç”±äºä¸æ˜¯åŸå­æ“ä½œï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šäº§ç”ŸæŒ‡ä»¤é‡æ’çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯åŸå­æ€§ï¼ŒåŒæ—¶åŠ ä¸ŠåŒé‡`if`æ¡ä»¶åˆ¤æ–­ã€‚æ‡’æ±‰å¼ (åŒæ­¥ä»£ç å—)æ­£ç¡®çš„å†™æ³•åº”è¯¥æ˜¯**åŒé‡æ£€æŸ¥DCL**

## 6. åŒé‡æ£€æŸ¥DCL

`volatile`å…³é”®å­—ä¿®é¥°ï¼Œè½»é‡çº§é”ï¼Œå¯ä»¥ä½¿å€¼ä¿®æ”¹åç«‹å³æ›´æ–°åˆ°ä¸»å­˜

```java
private volatile static SafeSingleton single = null;
```

ã€è¿™é‡Œæ·»åŠ `volatile`çš„åŸå› æ˜¯ã€‘

```java
single = new SafeSingleton();
```

**åˆ›å»ºå¯¹è±¡è¿™æ¡è¯­å¥ä¸æ˜¯åŸå­æ“ä½œ**

`new`å…³é”®å­—åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š

1. åˆ†é…å†…å­˜ç©ºé—´ï¼›

2. å †å†…å­˜ä¸Šåˆ›å»ºå¯¹è±¡ï¼ˆæ‰§è¡Œæ„é€ æ–¹æ³•ï¼‰ï¼›

3. å°†å¯¹è±¡çš„å¼•ç”¨æŒ‡å‘å †å†…å­˜ï¼›

ç”±äºä¸æ˜¯åŸå­æ“ä½œï¼Œå°±å¯èƒ½äº§ç”ŸæŒ‡ä»¤é‡æ’çš„é—®é¢˜ã€‚

æ­¥éª¤`2`å’Œæ­¥éª¤`3`å¯èƒ½ä¼šè¢«ç¼–è¯‘å™¨æŒ‡ä»¤é‡æ’ï¼Œ`1 -> 2 -> 3`çš„æ‰§è¡Œé¡ºåºå˜ä¸ºäº†`1 -> 3 -> 2`

å…ˆæŠŠå¯¹è±¡çš„å¼•ç”¨æŒ‡å‘å †ç©ºé—´ï¼Œç„¶åå†åœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡ã€‚(ç†è§£ä¸ºå›¾ä¹¦é¦†å åº§ä½ï¼Œäººè¿˜æ²¡åˆ°ï¼Œä½†æ˜¯ä½ç½®ä¸Šå´è¢«å ç”¨äº†)

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200615085636.png)

åˆ¤æ–­éç©ºï¼Œä½†æ˜¯å®é™…æ‹¿åˆ°çš„å¯¹è±¡è¿˜æœªå®Œæˆåˆå§‹åŒ–å»åˆ›å»ºï¼Œå°±ä¼šå‡ºç°**ç©ºæŒ‡é’ˆå¼‚å¸¸**ã€‚

æ‰€ä»¥è¦**é˜²æ­¢æŒ‡ä»¤é‡æ’ï¼Œä¿è¯æœ‰åºæ€§ï¼ŒåŠæ—¶é€šçŸ¥å…¶çº¿ç¨‹`single`çš„å®æ—¶çŠ¶æ€**ï¼Œå°±å¿…é¡»åŠ ä¸Š`volatile`å…³é”®å­—æ¥é˜²æ­¢æŒ‡ä»¤é‡æ’ï¼Œä¿è¯`1 -> 2 -> 3`çš„æ‰§è¡Œé¡ºåºã€‚

```java
class SafeSingleton {

    //ä½¿ç”¨volatileå…³é”®å­—ä¿å…¶å¯è§æ€§
    private volatile static SafeSingleton single = null;

    private SafeSingleton() { }

    //åŒæ­¥ä»£ç å—ä¸Šé”
    public static SafeSingleton getInstance() {
        if(single == null) {
            synchronized (SafeSingleton.class) {
                //åŒé‡æ£€æŸ¥
                if (single == null) {
                    single = new SafeSingleton();
                }
            }
        }
        return single;
    }

    public void print() {
        System.out.println("åŒé‡æ£€æµ‹é”çš„DCLå•ä¾‹");
    }
}

public class ReflectDCL {
    public static void main(String[] args) {
        //é™æ€æ–¹æ³•å–å¾—ç±»ä¸­å·²ç»äº§ç”Ÿå¥½çš„å¯¹è±¡
        SafeSingleton single = SafeSingleton.getInstance();
        single.print();
    }
}
```

**ã€åŒé‡æ£€æŸ¥åˆ†æã€‘**

- Double-Checkæ¦‚å¿µæ˜¯å¤šçº¿ç¨‹å¼€å‘ä¸­å¸¸ä½¿ç”¨åˆ°çš„ï¼Œå¦‚ä»£ç ä¸­æ‰€ç¤ºï¼Œæˆ‘ä»¬è¿›è¡Œäº†ä¸¤æ¬¡`if(single == null)`çš„æ£€æŸ¥ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨äº†ã€‚

- è¿™æ ·ï¼Œå®ä¾‹åŒ–ä»£ç åªç”¨æ‰§è¡Œä¸€æ¬¡ï¼Œåé¢å†æ¬¡è®¿é—®æ—¶ï¼Œåˆ¤æ–­`if(single == null)`ç›´æ¥ returnå®ä¾‹åŒ–å¯¹è±¡ï¼Œä¹Ÿé¿å…çš„åå¤è¿›è¡Œæ–¹æ³•åŒæ­¥

- çº¿ç¨‹å®‰å…¨ï¼›å»¶è¿ŸåŠ è½½ï¼›æ•ˆç‡è¾ƒé«˜

## 7. é™æ€å†…éƒ¨ç±»

æˆ‘ä»¬é¦–å…ˆå¯¹é™æ€å†…éƒ¨ç±»åšä¸€ä¸ªå›é¡¾ğŸ‘‰[è¿˜å¥½é¢è¯•å®˜è¿˜æ²¡é—®ï¼Œèµ¶ç´§æŠŠã€å†…éƒ¨ç±»ã€‘çš„çŸ¥è¯†ç‚¹è¡¥ä¸Š](https://blog.csdn.net/weixin_43232955/article/details/106151693)

é™æ€å†…éƒ¨ç±»ä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªå¤–éƒ¨ç±»çš„é™æ€æˆå‘˜è€Œå­˜åœ¨ï¼Œ**åˆ›å»ºä¸€ä¸ªç±»çš„é™æ€å†…éƒ¨ç±»å¯¹è±¡ä¸éœ€è¦ä¾èµ–å…¶å¤–éƒ¨ç±»å¯¹è±¡**

- åœ¨å¤–éƒ¨ç±»åŠ è½½æ—¶ï¼Œé™æ€å†…éƒ¨ç±»ä¸ä¼šè¢«ç«‹å³åŠ è½½ï¼Œè€Œæ˜¯åœ¨å¤–éƒ¨ç±»ä¸­è¢«ä½¿ç”¨æ—¶æ‰ä¼šåŠ è½½ï¼Œè¿™ç¬¦åˆæ‡’åŠ è½½çš„ç­–ç•¥ã€‚

- å½“æˆ‘ä»¬åœ¨å¤–éƒ¨ç±»ä¸­è°ƒç”¨é™æ€å†…éƒ¨ç±»æ—¶ï¼Œä¼šè¢«åŠ è½½ï¼Œå¹¶ä¸”åªä¼šè¢«åŠ è½½ä¸€æ¬¡ï¼Œåœ¨åŠ è½½æ—¶çº¿ç¨‹æ˜¯å®‰å…¨çš„ï¼Œä¿éšœäº†çº¿ç¨‹çš„å®‰å…¨æ€§ã€‚

```java
class StaticInner {

    private StaticInner() { }

    //é™æ€å†…éƒ¨ç±»
    private static class Singleton {
        private static final StaticInner INSTANCE = new StaticInner();
    }

    public static StaticInner getSingleton() {
        return Singleton.INSTANCE;
    }

    public void print() {
        System.out.println("é™æ€å†…éƒ¨ç±»çš„çº¿ç¨‹å®‰å…¨çš„æ‡’æ±‰å¼å•ä¾‹");
    }
}

public class StaticInnerSingle06 {
    public static void main(String[] args) {
        StaticInner single = StaticInner.getSingleton();
        single.print();
    }
}
```

**é™æ€å†…éƒ¨ç±»**

1. è¿™ç§æ–¹å¼é‡‡ç”¨äº†ç±»è£…è½½çš„æœºåˆ¶æ¥ä¿è¯åˆå§‹åŒ–å®ä¾‹æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹
2. é™æ€å†…éƒ¨ç±»æ–¹å¼åœ¨å¤–éƒ¨ç±»è¢«åŠ è½½æ—¶å¹¶ä¸ä¼šç«‹å³å˜ä¾‹åŒ–ï¼Œè€Œæ˜¯åœ¨éœ€è¦å®ä¾‹åŒ–æ—¶ï¼Œè°ƒç”¨getSingletonæ–¹æ³•ï¼Œæ‰ä¼šè£…è½½ Singletonå†…éƒ¨ç±»ï¼Œä»è€Œå®Œæˆå¤–éƒ¨ç±»çš„å®ä¾‹åŒ–ã€‚
3. ç±»çš„é™æ€å±æ€§åªä¼šåœ¨ç¬¬ä¸€æ¬¡åŠ è½½ç±»çš„æ—¶å€™åˆå§‹åŒ–ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œï¼ŒJVMå¸®åŠ©æˆ‘ä»¬ä¿è¯äº†çº¿ç¨‹çš„å®‰å…¨æ€§ï¼Œåœ¨ç±»è¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œåˆ«çš„çº¿ç¨‹æ˜¯æ— æ³•è¿›å…¥çš„
4. ä¼˜ç‚¹ï¼šé¿å…äº†çº¿ç¨‹ä¸å®‰å…¨ï¼Œåˆ©ç”¨é™æ€å†…éƒ¨ç±»çš„ç‰¹ç‚¹å®ç°å»¶è¿ŸåŠ è½½ï¼Œæ•ˆç‡é«˜

## 8. æšä¸¾

è¿™å€ŸåŠ©DK15ä¸­æ·»åŠ çš„æšä¸¾æ¥å®ç°å•ä¾‹æ¨¡å¼ã€‚ä¸ä»…èƒ½é¿å…å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œè€Œä¸”è¿˜èƒ½é˜²æ­¢ååºåˆ—åŒ–é‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚

```java
enum Singleton {
    INSTANCE; //å±æ€§

    public static Singleton getInstance() {
        return Singleton.INSTANCE;
    }
}

public class Enum07 {
    public static void main(String[] args) {
        Singleton single = Singleton.getInstance();
        Singleton single1 = Singleton.getInstance();
        System.out.println(single == single1);
    }
}
```



## 9. åå°„ï¼ä¸ºæ‰€æ¬²ä¸ºï¼Ÿ

> å…ˆæ¥å¯¹åå°„çš„å†…å®¹åšä¸ªå›é¡¾ğŸ‘‰[**åå°„ï¼Œå°±æ˜¯è¦ä¸ºæ‰€æ¬²ä¸º**](https://blog.csdn.net/weixin_43232955/article/details/96263195?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522159215012019724839224521%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=159215012019724839224521&biz_id=0)

### DCLåŒé‡æ£€æŸ¥ç ´å

é€šè¿‡åå°„æˆ–è€…åºåˆ—åŒ–ä¼šç ´åå•ä¾‹ï¼Œæˆ‘ä»¬å°±ä»¥çº¿ç¨‹å®‰å…¨çš„DCLå•ä¾‹æ¥è¯´æ˜ã€‚

è¿˜æ˜¯tittle6çš„ä»£ç ï¼Œæˆ‘ä»¬é€šè¿‡åå°„æ¥ç ´å

```java
public static void main(String[] args) throws Exception {
    SafeSingleton single = SafeSingleton.getInstance();
    Constructor<SafeSingleton> dc = SafeSingleton.class.getDeclaredConstructor();
    dc.setAccessible(true);
    SafeSingleton singleCopy = dc.newInstance();
    //false,å•ä¾‹è¢«ç ´å
    System.out.println(singleCopy == single);
}
```

> ç»“æœè¾“å‡ºï¼šfalse

è¾“å‡ºä¸ºfalseï¼Œè¯´æ˜å•ä¾‹æ¨¡å¼åˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡ï¼Œè¢«åå°„ç ´åäº†ã€‚é‚£å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

é¦–å…ˆï¼Œåå°„æ˜¯é€šè¿‡**æ— å‚æ„é€ **æ¥åˆ›å»ºclasså¯¹è±¡çš„ï¼Œæˆ‘ä»¬åœ¨`SafeSingleton`çš„æ„é€ ä¸­å†åŠ ä¸€æŠŠé”æ¥åˆ¤æ–­ï¼š

```java
class SafeSingleton {

    //ä½¿ç”¨volatileå…³é”®å­—ä¿å…¶å¯è§æ€§
    private volatile static SafeSingleton single = null;

    private SafeSingleton() {
        synchronized (SafeSingleton.class) {
            if (single != null) {
                throw new RuntimeException("Don't destroy by reflection");
            }
        }
    }

    //åŒæ­¥ä»£ç å—ä¸Šé”
    public static SafeSingleton getInstance() {
        if(single == null) {
            synchronized (SafeSingleton.class) {
                //åŒé‡æ£€æŸ¥
                if (single == null) {
                    single = new SafeSingleton();
                }
            }
        }
        return single;
    }
}

public class ReflectDCL {
    public static void main(String[] args) throws Exception {
        SafeSingleton single = SafeSingleton.getInstance();
        Constructor<SafeSingleton> dc = SafeSingleton.class.getDeclaredConstructor();
        dc.setAccessible(true);
        SafeSingleton singleCopy = dc.newInstance();
        //false,å•ä¾‹è¢«ç ´å
        System.out.println(singleCopy == single);
    }
}
```

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200614212526.png)

é—®é¢˜è§£å†³ï¼Œæ­¤æ—¶åå°„æ— æ³•åˆ›å»ºå¯¹è±¡ã€‚

### é—®é¢˜åˆåŒå‡ºç°

åˆšæ‰å•ä¾‹çš„å¯¹è±¡æ˜¯é€šè¿‡ç§æœ‰æ„é€ æ–¹æ³•åˆ›å»ºçš„ï¼Œå³è°ƒç”¨äº†`getInstance()`æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæˆ‘ä¸ç”¨è¿™æ ·åˆ›å»ºï¼Œæˆ‘å”¯ä¸€ä¸€ä¸ªå¯¹è±¡ä¹Ÿæ˜¯é€šè¿‡åå°„æ¥åˆ›å»ºå‘¢ï¼Ÿ

å°†

```java
SafeSingleton single = SafeSingleton.getInstance();
```

æ¢æˆ

```java
SafeSingleton single = dc.newInstance();
```

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200614213637.png)

è¿™æ—¶ï¼Œå•ä¾‹æ¨¡å¼åˆå‡ºå¹ºè›¾å­äº†ï¼Œåˆè¢«åå°„çˆ†ç ´äº†ï¼

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200614213717.png)

### é—®é¢˜è§£å†³

æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ä¸€ä¸ªæ ‡å¿—ä½`flag`æ¥åˆ¤æ–­ï¼Œé˜²æ­¢åå°„ç ´å

```java
class SafeSingleton03 {

    //ä½¿ç”¨volatileå…³é”®å­—ä¿å…¶å¯è§æ€§
    private volatile static SafeSingleton03 single = null;
    //æ·»åŠ æ ‡å¿—ä½
    private static boolean flag = false;

    private SafeSingleton03() {
        synchronized (SafeSingleton03.class) {
            if (flag == false) {
                flag = true;
            }else {
                throw new RuntimeException("Don't destroy by reflection");
            }
        }
    }

    //åŒæ­¥ä»£ç å—ä¸Šé”
    public static SafeSingleton03 getInstance() {
        if(single == null) {
            synchronized (SafeSingleton03.class) {
                //åŒé‡æ£€æŸ¥
                if (single == null) {
                    single = new SafeSingleton03();
                }
            }
        }
        return single;
    }

    public static void main(String[] args) throws Exception {
        Constructor<SafeSingleton03> dc = SafeSingleton03.class.getDeclaredConstructor();
        dc.setAccessible(true);
        SafeSingleton03 single = dc.newInstance();
        SafeSingleton03 singleCopy = dc.newInstance();

        System.out.println(single);
        System.out.println(singleCopy);
        System.out.println(single == singleCopy);
    }
}

```

å†æ¬¡æ‰§è¡Œï¼Œæˆ‘ä»¬å‘ç°æ ‡å¿—ä½æ³•å¯ä»¥æ‹¦æˆªä¸¤æ¬¡åå°„çš„ç ´åã€‚

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200614225601.png)



### é—®é¢˜åˆåŒå’å‡ºç°

åœ¨åå°„ä¸­ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥è·å–æ„é€ æ–¹æ³•å‘€ï¼Œè¿˜å¯ä»¥è·å–æˆå‘˜å˜é‡å‘€ã€‚é‚£`flag`é€šè¿‡åå°„è·å–å¹¶ä¿®æ”¹ï¼Œä¸å°±æœ‰ä¸è¡Œäº†ï¼Ÿ

```java
class SafeSingleton03 {

    //ä½¿ç”¨volatileå…³é”®å­—ä¿å…¶å¯è§æ€§
    private volatile static SafeSingleton03 single = null;
    //æ·»åŠ æ ‡å¿—ä½
    private static boolean flag = false;

    private SafeSingleton03() {
        synchronized (SafeSingleton03.class) {
            if (flag == false) {
                flag = true;
            }else {
                throw new RuntimeException("Don't destroy by reflection");
            }
        }
    }

    //åŒæ­¥ä»£ç å—ä¸Šé”
    public static SafeSingleton03 getInstance() {
        if(single == null) {
            synchronized (SafeSingleton03.class) {
                //åŒé‡æ£€æŸ¥
                if (single == null) {
                    single = new SafeSingleton03();
                }
            }
        }
        return single;
    }

    public static void main(String[] args) throws Exception {
        Constructor<SafeSingleton03> dc = SafeSingleton03.class.getDeclaredConstructor();
        dc.setAccessible(true);
        SafeSingleton03 single = dc.newInstance();

        //å†æ¬¡é€šè¿‡åå°„ä¿®æ”¹å±æ€§å€¼
        Field flag = SafeSingleton03.class.getDeclaredField("flag");
        flag.setAccessible(true);
        flag.set(dc,false);

        SafeSingleton03 singleCopy = dc.newInstance();

        System.out.println(single);
        System.out.println(singleCopy);
        System.out.println(single == singleCopy);
    }
}
```

é€šè¿‡ä»£ç éªŒè¯ï¼Œæˆ‘ä»¬å‘ç°ç¡®å®åˆåŒå‡ºç°é—®é¢˜äº†ï¼

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200614231312.png)

é‚£è¿™ï¼Œåˆè¯¥æ€ä¹ˆæï¼Ÿ

é—®é¢˜ï¼Œå°±å‡ºåœ¨äº†`newInstance`æ–¹æ³•ä¸Šï¼Œé€šè¿‡åå°„æ¥åˆ›å»ºå¯¹è±¡ã€‚

æˆ‘ä»¬ç‚¹å¼€æºç çœ‹çœ‹ğŸ‘€

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200614231701.png)

å’¦ï¼Œæšä¸¾è‡ªå¸¦å•ä¾‹æ¨¡å¼ï¼Œåå°„è¿˜ç ´åä¸äº†ã€‚æ˜¯è¿™æ ·å—ï¼Ÿæˆ‘ä»¬ç»§ç»­éªŒè¯

### é—®é¢˜æœ€ç»ˆè§£å†³

**æµ‹è¯•åå°„èƒ½å¦ç ´åæšä¸¾å¼å•ä¾‹**

```java
enum EnumSingleton {
    INSTANCE;
}

public class EnumTest {
    public static void main(String[] args) throws Exception {
        EnumSingleton single = EnumSingleton.INSTANCE;
        Constructor<EnumSingleton> dc = EnumSingleton.class.getDeclaredConstructor(String.class,int.class);
        dc.setAccessible(true);
        EnumSingleton singleCopy = dc.newInstance();

        System.out.println(single);
        System.out.println(singleCopy);
        System.out.println(single == singleCopy);
    }
}
```

> è‡³äºä¸ºä»€ä¹ˆåå°„è·å–çš„æ„é€ æ–¹æ³•ä¼ å…¥Stringã€intå‚æ•°ï¼Œéœ€è¦é€šè¿‡[Jad](http://java-decompiler.github.io/)åç¼–è¯‘æ¥æŸ¥çœ‹ã€‚**ä¸èƒ½ä¼ å…¥ç©ºå‚æ„é€ **ï¼Œå¦åˆ™å‡ºç°çš„æ˜¯`NoSuchMethodException`

å‡ºç°æºç ä¸­æŠ›å‡ºçš„å¼‚å¸¸`IllegalArgumentException`

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200614233420.png)

> ç¨‹åºæœ€ç»ˆæŠ›å‡ºï¼šjava.lang.IllegalArgumentException: Cannot reflectively create enum objectså¼‚å¸¸



--------------------------------------------

## æ€»ç»“

åœ¨JDKä¸­ï¼Œ`java.lang.Runtime`å°±æ˜¯ç»å…¸çš„å•ä¾‹æ¨¡å¼

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img/20200609230253.png)

æŒæ¡è¿™æ ·ä¸€äº›å•ä¾‹æ¨¡å¼çš„å¥‡æ·«æŠ€å·§ï¼Œåœ¨å†ç»åå°„çš„é‡é‡çˆ†ç ´ä¹‹åï¼Œç›¸ä¿¡ä½ ä¼šå¯¹å•ä¾‹æ¨¡å¼æœ‰æ–°çš„äº†è§£ï¼
