## 1. TCP协议特点

1. **面向连接**（虚连接）

2. **点对点传输**。每一条TCP连接只能有两个端点

3. **可靠有序，不丢不重**。TCP提供可靠的交付服务。无差错，不丢失，不重复，按序到达

4. **全双工通信**。

5. **面向字节流**。

【全双工通信】

发送方和接收方可以同时发送数据，接收数据。协议两端都设有发送缓存，接收缓存

【面向字节流】

----------------------

## 2. TCP报文首部格式

`20B`的**固定首部** + 选项字段，**4B对齐**方式

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/imgs01/20200726174304.png)

【源端口】：发送方端口，`16位`

【目的端口】：接收方端口，`16位`

【序号】：<u>本报文段</u>所发送的数据-的<font color = red>第一个字节的序号</font>

【确认号】：<font color = red>期望</font>收到下一个报文段数据的<font color = red>第一个字节的序号</font>

【数据偏移】：TCP首部长度，最大长度为(2^4^ - 1) * 4B = `60B`，固定首部`20B` + 可变头部`40B`。由于首部长度不固定，所以数据起始位置不固定

【<mark>六个控制位</mark>】

- 紧急位`URG`：`URG=1`表示此段报文有紧急数据，不用再缓存队列中排队，配合<u>紧急指针</u>**插队优先发送**

- 确认位`ACK`：`ACK=1`，确认号有效

- 推送位`PSH`：`PSH=1`时，接收方尽快向应用进程交付此段报文，不必等缓存队列填满

- 复位`RST`：`RST=1`时，表示TCP与主机的连接**出现严重差错**，必须释放连接再重新建立

- 同步位`SYN`：`SYN=1`，表明一个连接 **请求/连接**接收报文

- 终止位`FIN`：`FIN=1`，表明发送方数据已发完，要求释放连接

【窗口】：接收方接收窗口的大小，即现在允许发送方发送的数据量

【检验和】：**检验首部 + 数据**，检验时要加上`12B`伪首部，第四个字段为`6`

【紧急指针】：`URG=1`时才有意义，指出本报文段中紧急数据的字节数

【选项】：最大报文段长度MSS、窗口扩大、时间戳、选择确认

【填充】：填充0保证4字节对齐

### 序号&确认号

**序号：**<u>本报文段</u>所发送的数据-的<font color = red>第一个字节的序号</font>

**确认号**：确认上一次发送的成功收到。<font color = red>期望</font>收到下一个报文段数据的<font color = red>第一个字节的序号</font>

 ![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/imgs01/20200727100928.png)

序号的初始值是在建立连接后，**随机生成的**

### TCP三次握手机制中的seq和ack的值

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/imgs01/20200727162741.png)

<font size = 5><center>三次握手</center></font>

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/imgs01/20200727162558.png)

<font size = 5><center>四次挥手</center></font>

- **seq是数据包本身的序号**

- **ack是期望对方继续发送的那个数据包的序列号，即确认号**

> [TCP三次握手机制中的seq和ack的值](https://www.jianshu.com/p/5dae584f795a)

seq是序列号，这是为了连接以后传送数据用的，ack是对收到的数据包的确认，值是等待接收的数据包的序列号。  

在第一次消息发送中，A随机选取一个序列号作为自己的初始序号发送给B；第二次消息B使用ack对A的数据包进行确认，因为已经收到了序列号为x的数据包，准备接收序列号为x+1的包，所以ack=x+1，同时B告诉A自己的初始序列号，就是seq=y；第三条消息A告诉B收到了B的确认消息并准备建立连接，A自己此条消息的序列号是x+1，所以seq=x+1，而ack=y+1是表示A正准备接收B序列号为y+1的数据包。  
